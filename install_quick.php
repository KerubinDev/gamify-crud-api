<?php
/**
 * Instala√ß√£o R√°pida - Sistema Vida Equilibrada
 * Para quem tem pregui√ßa de configurar! üòÑ
 */

echo "üöÄ Instala√ß√£o R√°pida - Vida Equilibrada\n";
echo "=====================================\n\n";

// Configura√ß√µes padr√£o (XAMPP/Laragon)
$config = [
    'db_host' => 'localhost',
    'db_name' => 'vida_equilibrada',
    'db_user' => 'root',
    'db_pass' => '',
    'app_url' => 'http://localhost/gamify-crud-api'
];

echo "üìã Configura√ß√µes padr√£o:\n";
echo "Host: {$config['db_host']}\n";
echo "Banco: {$config['db_name']}\n";
echo "Usu√°rio: {$config['db_user']}\n";
echo "Senha: (vazia)\n";
echo "URL: {$config['app_url']}\n\n";

echo "‚öôÔ∏è Iniciando instala√ß√£o...\n\n";

try {
    // Passo 1: Testar conex√£o
    echo "1Ô∏è‚É£ Testando conex√£o com MySQL...\n";
    $pdo = new PDO(
        "mysql:host={$config['db_host']};charset=utf8mb4",
        $config['db_user'],
        $config['db_pass'],
        [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
    );
    echo "‚úÖ Conex√£o estabelecida!\n\n";
    
    // Passo 2: Criar banco
    echo "2Ô∏è‚É£ Criando banco de dados...\n";
    $pdo->exec("CREATE DATABASE IF NOT EXISTS `{$config['db_name']}` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
    echo "‚úÖ Banco '{$config['db_name']}' criado!\n\n";
    
    // Passo 3: Conectar ao banco
    echo "3Ô∏è‚É£ Conectando ao banco...\n";
    $pdo = new PDO(
        "mysql:host={$config['db_host']};dbname={$config['db_name']};charset=utf8mb4",
        $config['db_user'],
        $config['db_pass'],
        [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
    );
    echo "‚úÖ Conectado ao banco!\n\n";
    
    // Passo 4: Importar esquema
    echo "4Ô∏è‚É£ Importando esquema do banco...\n";
    $sqlFile = __DIR__ . '/database/database.sql';
    
    if (!file_exists($sqlFile)) {
        throw new Exception("‚ùå Arquivo database.sql n√£o encontrado!");
    }
    
    $sql = file_get_contents($sqlFile);
    $commands = array_filter(array_map('trim', explode(';', $sql)));
    
    foreach ($commands as $command) {
        if (!empty($command)) {
            $pdo->exec($command);
        }
    }
    echo "‚úÖ Esquema importado!\n\n";
    
    // Passo 5: Criar configura√ß√£o
    echo "5Ô∏è‚É£ Criando arquivo de configura√ß√£o...\n";
    $configContent = generateConfigFile($config);
    
    $configFile = __DIR__ . '/api/config/database.php';
    if (!is_dir(dirname($configFile))) {
        mkdir(dirname($configFile), 0755, true);
    }
    
    if (file_put_contents($configFile, $configContent) === false) {
        throw new Exception("‚ùå Erro ao criar arquivo de configura√ß√£o!");
    }
    echo "‚úÖ Configura√ß√£o criada!\n\n";
    
    // Passo 6: Criar diret√≥rios
    echo "6Ô∏è‚É£ Criando diret√≥rios necess√°rios...\n";
    $dirs = ['logs', 'uploads', 'cache'];
    foreach ($dirs as $dir) {
        if (!is_dir($dir)) {
            mkdir($dir, 0755, true);
        }
    }
    echo "‚úÖ Diret√≥rios criados!\n\n";
    
    // Passo 7: Testar funcionalidades
    echo "7Ô∏è‚É£ Testando funcionalidades...\n";
    $tables = ['usuarios', 'habitos', 'habitos_completados', 'badges', 'badges_conquistadas', 'ranking_historico'];
    foreach ($tables as $table) {
        $stmt = $pdo->query("SHOW TABLES LIKE '$table'");
        if ($stmt->rowCount() === 0) {
            throw new Exception("‚ùå Tabela '$table' n√£o foi criada!");
        }
    }
    echo "‚úÖ Todas as tabelas criadas!\n\n";
    
    // Passo 8: Finalizar
    echo "8Ô∏è‚É£ Finalizando instala√ß√£o...\n";
    $lockFile = __DIR__ . '/installed.lock';
    $lockContent = json_encode([
        'installed_at' => date('Y-m-d H:i:s'),
        'version' => '1.0.0',
        'config' => $config
    ], JSON_PRETTY_PRINT);
    
    file_put_contents($lockFile, $lockContent);
    echo "‚úÖ Instala√ß√£o finalizada!\n\n";
    
    // Sucesso!
    echo "üéâ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO! üéâ\n";
    echo "=====================================\n\n";
    echo "üì± Acesse sua aplica√ß√£o em:\n";
    echo "   {$config['app_url']}\n\n";
    echo "üéÆ Ou abra diretamente:\n";
    echo "   {$config['app_url']}/index.html\n\n";
    echo "üìä Para testar a API:\n";
    echo "   {$config['app_url']}/api/\n\n";
    echo "üîß Configura√ß√µes salvas em:\n";
    echo "   api/config/database.php\n\n";
    echo "üìù Logs em:\n";
    echo "   logs/app.log\n\n";
    echo "‚ú® Boa sorte em sua jornada de gamifica√ß√£o! ‚öîÔ∏èüèÜ\n";
    
} catch (Exception $e) {
    echo "‚ùå ERRO NA INSTALA√á√ÉO!\n";
    echo "=====================\n\n";
    echo "Erro: " . $e->getMessage() . "\n\n";
    echo "üîß Solu√ß√µes poss√≠veis:\n";
    echo "1. Verifique se o MySQL est√° rodando\n";
    echo "2. Verifique se o usu√°rio 'root' existe\n";
    echo "3. Verifique se o arquivo database.sql existe\n";
    echo "4. Verifique as permiss√µes de escrita\n\n";
    echo "üí° Dica: Use XAMPP ou Laragon para facilitar!\n";
}

/**
 * Gera arquivo de configura√ß√£o
 */
function generateConfigFile($config) {
    return "<?php
/**
 * Configura√ß√£o do Banco de Dados
 * Sistema Vida Equilibrada
 * Gerado automaticamente em " . date('Y-m-d H:i:s') . "
 */

// Configura√ß√µes do banco de dados
define('DB_HOST', '{$config['db_host']}');
define('DB_NAME', '{$config['db_name']}');
define('DB_USER', '{$config['db_user']}');
define('DB_PASS', '{$config['db_pass']}');
define('DB_CHARSET', 'utf8mb4');

// Configura√ß√µes da aplica√ß√£o
define('APP_NAME', 'Vida Equilibrada');
define('APP_VERSION', '1.0.0');
define('APP_URL', '{$config['app_url']}');
define('APP_ENVIRONMENT', 'production');

// Configura√ß√µes de seguran√ßa
define('JWT_SECRET', '" . bin2hex(random_bytes(32)) . "');
define('PASSWORD_SALT', '" . bin2hex(random_bytes(16)) . "');

// Configura√ß√µes de gamifica√ß√£o
define('PONTOS_BASE_HABITO', 10);
define('BONUS_STREAK_3', 25);
define('BONUS_STREAK_7', 50);
define('BONUS_STREAK_30', 100);
define('MULTIPLICADOR_MADRUGADOR', 1.5);
define('MULTIPLICADOR_NOITE', 1.2);
define('PONTOS_POR_NIVEL', 100);

// Configura√ß√µes de API
define('API_VERSION', 'v1');
define('API_RATE_LIMIT', 1000);
define('API_RATE_WINDOW', 3600);

// Configura√ß√µes de cache
define('CACHE_ENABLED', true);
define('CACHE_TTL', 3600);

// Configura√ß√µes de log
define('LOG_ENABLED', true);
define('LOG_LEVEL', 'INFO');
define('LOG_FILE', __DIR__ . '/../../logs/app.log');

// Configura√ß√µes de manuten√ß√£o
define('MAINTENANCE_MODE', false);
define('MAINTENANCE_MESSAGE', 'Sistema em manuten√ß√£o. Volte em breve!');

// Configura√ß√µes de upload
define('UPLOAD_MAX_SIZE', 10485760); // 10MB
define('UPLOAD_ALLOWED_TYPES', ['jpg', 'jpeg', 'png', 'gif', 'pdf']);

// Configura√ß√µes de email
define('SMTP_HOST', 'localhost');
define('SMTP_PORT', 587);
define('SMTP_USER', '');
define('SMTP_PASS', '');
define('SMTP_FROM', 'noreply@vidaequilibrada.com');

// Configura√ß√µes de timezone
date_default_timezone_set('America/Sao_Paulo');

// Configura√ß√µes de sess√£o
ini_set('session.cookie_httponly', 1);
ini_set('session.use_only_cookies', 1);
ini_set('session.cookie_secure', isset(\$_SERVER['HTTPS']));

// Configura√ß√µes de erro
if (APP_ENVIRONMENT === 'development') {
    error_reporting(E_ALL);
    ini_set('display_errors', 1);
} else {
    error_reporting(0);
    ini_set('display_errors', 0);
}

// Configura√ß√µes de log
ini_set('log_errors', 1);
ini_set('error_log', __DIR__ . '/../../logs/php_errors.log');

// Fun√ß√£o para log personalizado
function logMessage(\$message, \$level = 'INFO') {
    if (!LOG_ENABLED) return;
    
    if (!is_dir(dirname(LOG_FILE))) {
        mkdir(dirname(LOG_FILE), 0755, true);
    }
    
    \$timestamp = date('Y-m-d H:i:s');
    \$logEntry = \"[\$timestamp] [\$level] \$message\" . PHP_EOL;
    
    file_put_contents(LOG_FILE, \$logEntry, FILE_APPEND | LOCK_EX);
}

// Fun√ß√£o para sanitizar entrada
function sanitizeInput(\$data) {
    if (is_array(\$data)) {
        return array_map('sanitizeInput', \$data);
    }
    return htmlspecialchars(trim(\$data), ENT_QUOTES, 'UTF-8');
}

// Fun√ß√£o para validar email
function validateEmail(\$email) {
    return filter_var(\$email, FILTER_VALIDATE_EMAIL);
}

// Fun√ß√£o para gerar token
function generateToken(\$length = 32) {
    return bin2hex(random_bytes(\$length));
}

// Fun√ß√£o para hash de senha
function hashPassword(\$password) {
    return password_hash(\$password, PASSWORD_BCRYPT, ['cost' => 12]);
}

// Fun√ß√£o para verificar senha
function verifyPassword(\$password, \$hash) {
    return password_verify(\$password, \$hash);
}

// Fun√ß√£o para calcular pontos
function calcularPontos(\$pontos_base, \$streak_atual, \$hora_completamento) {
    \$pontos = \$pontos_base;
    
    // B√¥nus de streak
    if (\$streak_atual >= 30) {
        \$pontos += BONUS_STREAK_30;
    } elseif (\$streak_atual >= 7) {
        \$pontos += BONUS_STREAK_7;
    } elseif (\$streak_atual >= 3) {
        \$pontos += BONUS_STREAK_3;
    }
    
    // Multiplicador por hor√°rio
    \$multiplicador = getMultiplicadorHorario(\$hora_completamento);
    \$pontos = \$pontos * \$multiplicador;
    
    return round(\$pontos);
}

// Fun√ß√£o para obter multiplicador por hor√°rio
function getMultiplicadorHorario(\$hora) {
    \$hora_int = (int) \$hora;
    
    if (\$hora_int >= 5 && \$hora_int <= 7) {
        return MULTIPLICADOR_MADRUGADOR;
    } elseif (\$hora_int >= 22 || \$hora_int <= 0) {
        return MULTIPLICADOR_NOITE;
    }
    
    return 1.0;
}

// Classe de conex√£o com banco de dados
class Database {
    private \$connection;
    private static \$instance = null;
    
    private function __construct() {
        try {
            \$this->connection = new PDO(
                'mysql:host=' . DB_HOST . ';dbname=' . DB_NAME . ';charset=' . DB_CHARSET,
                DB_USER,
                DB_PASS,
                [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::ATTR_EMULATE_PREPARES => false
                ]
            );
        } catch (PDOException \$e) {
            logMessage('Erro de conex√£o com banco: ' . \$e->getMessage(), 'ERROR');
            throw new Exception('Erro de conex√£o com banco de dados');
        }
    }
    
    public static function getInstance() {
        if (self::\$instance === null) {
            self::\$instance = new self();
        }
        return self::\$instance;
    }
    
    public function getConnection() {
        return \$this->connection;
    }
    
    public function testConnection() {
        try {
            \$stmt = \$this->connection->query('SELECT 1');
            return \$stmt !== false;
        } catch (PDOException \$e) {
            return false;
        }
    }
}

// Log de inicializa√ß√£o
logMessage('Sistema iniciado - Ambiente: ' . APP_ENVIRONMENT, 'INFO');
?>";
}
?>

